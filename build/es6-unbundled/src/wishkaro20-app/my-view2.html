<html><head><link rel="import" href="../../bower_components/polymer/polymer-element.html"><link rel="import" href="../../bower_components/iron-list/iron-list.html"><link rel="import" href="../../bower_components/iron-image/iron-image.html"><link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html"><link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html"><link rel="import" href="../../bower_components/paper-toast/paper-toast.html"><link rel="import" href="../../bower_components/paper-button/paper-button.html"><link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html"><link rel="import" href="../../bower_components/iron-icons/iron-icons.html"><link rel="import" href="../../bower_components/iron-icons/social-icons.html"><link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html"><link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html"><link rel="import" href="sharedstyles.html"><link rel="import" href="my-firestoreinit.html"><link rel="import" href="my-firestorequery.html"><link rel="import" href="my-overlay.html"></head><body><dom-module id="my-view2"><template><style include="sharedstyles">:host{top:92px;}</style><my-firestoreinit firestoreconfig="{{dbconfig}}" firestorelistsize="{{listsize}}" firestorecollectionhndl="{{dbhandle}}"></my-firestoreinit><my-firestorequery firestorereadconfig="{{dbreadconfig}}" firestorefetchdata="{{reqdata}}" firestoredataobject="{{dataobject}}"></my-firestorequery><div class="container"><iron-list style="width:100%" items="[[imagearray]]" as="item" id="itemlist" scroll-target="document" selection-enabled="" selected-item="{{selecteditem}}" grid=""><template><div class="flexchild" style="width:calc(50% - .5px);"><iron-image class="imagecontainer" sizing="cover" style="width:calc(100% - 4px); height:180px; background-color: lightgray;" preload="" fade="" src="[[item.webp]]" error="{{imageloaderror}}"></iron-image></div></template></iron-list><template is="dom-if" if="{{!_hidespinner}}"><div class="spinnerpos"><paper-spinner active="" class="thick"></paper-spinner></div></template><paper-toast id="papertoast" class="fit-bottom" text="Hello world!"><paper-button id="papertoastbutton" style="left:16px;" on-click="displayToastClicked"></paper-button></paper-toast></div></template><script>class MyView2 extends Polymer.GestureEventListeners(Polymer.Element){static get is(){return"my-view2"}static get properties(){return{viewconfig:{type:Object,value:{collection:"null",sequnce:"null",limit:0}},dbready:{type:Boolean,value:!1,observer:"databaseReady"},dbconfig:{type:Object,value:{collection:"null",orderby:"null"},notify:!0},dbreadconfig:{type:Object,value:{limit:0,orderby:"null",index:"null",dbhandle:{}},notify:!0},reqdata:{type:Boolean,value:!1,notify:!0},dataobject:{type:Object,value:"null",observer:"processData"},listsize:{type:Number,value:0,observer:"DatabaseSize"},dbhandle:{type:Object,value:"null"},imagearray:{type:Array,value:[]},imageloaderror:{type:Boolean,value:!1,observer:"ImageLoadError"},selecteditem:{type:Object,observer:"ImageSelected",notify:!0},categoryselected:{type:Object,notify:!0},_previousselection:{type:Object},_selectiontimeout:{type:Object},_hidespinner:{type:Boolean,value:!1},statemachine:{type:Object},toaststate:{type:Object,value:{NEW_CONTENT:"newcontent",MOVE_TAB:"movetab"}}}}constructor(){super();this.stateMachineConstructor();this._observerinit={imageselected:"none"}}ready(){super.ready();this.initializeStateMachine();Polymer.Gestures.addListener(this,"track",e=>this.handleTrackEvent(e));Polymer.Gestures.setTouchAction(this,"auto")}stateMachineConstructor(){this.statemachine={state:"idle",action:{FIREBASEINIT:"firebaseinit",FIREASTOREINIT_SUCCESS:"firestoreinitsuccess",TRACK:"trackevent",HANDLE_DATA:"handledata",LIST_UPDATED:"newdataind",ITEM_SELECTED:"categorySelected",TOAST_CLICKED:"toastClicked"},list:{size:0,newsize:0,viewsize:0,pagelen:0},transitions:{idle:{initialize:function(parent){this.target=parent},firebaseinit:function(){this.target.flushViewData();this.target.initFirestore(this.target.viewconfig.collection);console.log("Firebase Init complete")},firestoreinitsuccess:function(size){console.log("FirestoreInit success List size = "+size);this.target.statemachine.list.size=size;this.target.setReadConfig(this.target.dbhandle,this.target.viewconfig.limit,this.target.viewconfig.sequence);this.target.statemachine.state="processing";this.target.readData(this.target.statemachine.list.size)},firestoreiniterror:function(){console.log("Firestore Init Error")},newdataind:function(data){console.log("New data is available");this.target.displayToast("New data idle","ok",2e3);this.target.statemachine.listsize=data}},ready:{initialize:function(traget){this.target=traget},newdataind:function(size){console.log("New data is available");this.target.displayToast("Updating NEW category"," ",3e3);this.target.flushViewData();this.target.statemachine.state="idle";this.target.setaction(this.target.statemachine.action.FIREASTOREINIT_SUCCESS,size)},trackevent:function(){console.log("Tracking started");if(this.target.$.itemlist.lastVisibleIndex>=this.target.imagearray.length-5&&this.target.statemachine.list.size>this.target.statemachine.list.viewsize){this.target.statemachine.state="processing";this.target.readData(this.target.statemachine.list.size-this.target.statemachine.list.viewsize)}},categorySelected:function(categoryobj){console.log("category selected");this.target.categoryselected=categoryobj},toastClicked:function(){console.log("Toast clicked")}},processing:{initialize:function(traget){this.target=traget},error:function(){console.log("Error occured")},handledata:function(dataobj){console.log("Processing Data");this.target.updateView(dataobj.get("webp"),dataobj.get("page"),dataobj.get("collection"),dataobj.get("title"));this.target.updateListStats()},newdataind:function(size){console.log("New data is available");this.target.statemachine.newsize=size;this.target.displayToast("Updating NEW category"," ",3e3);this.target.statemachine.state="idle";this.target.setaction(this.target.statemachine.action.FIREBASEINIT)},categorySelected:function(categoryobj){console.log("category selected");this.target.categoryselected=categoryobj},toastClicked:function(){console.log("Toast Clicked")}}}}}initializeStateMachine(){this.statemachine.transitions.idle.initialize(this);this.statemachine.transitions.ready.initialize(this);this.statemachine.transitions.processing.initialize(this)}setaction(action,data){this.statemachine.transitions[this.statemachine.state][action](data)}initFirestore(collection){this.dbconfig.collection=collection;this.dbconfig.orderby=this.viewconfig.sequence;this.notifyPath("dbconfig.collection")}flushViewData(){this.imagearray.length=0;this.statemachine.list.viewsize=0;this.statemachine.list.size=0;this.statemachine.list.newsize=0;Polymer.flush()}setReadConfig(handle,limit,sequence){this.dbreadconfig.limit=limit;this.dbreadconfig.orderby=sequence;this.dbreadconfig.dbhandle=handle}readData(index){this.dbreadconfig.index=index;this.reqdata=!this.reqdata}updateView(webp,page,collection,title){var imageobject={};imageobject.webp=webp;imageobject.page=page;imageobject.collection=collection;imageobject.title=title;this.push("imagearray",imageobject)}updateListStats(){this.statemachine.list.viewsize++;this.statemachine.list.pagelen++;if(this.statemachine.list.pagelen===this.dbreadconfig.limit){console.log("Completed page read");this.statemachine.list.pagelen=0;this.statemachine.state="ready"}if(this.statemachine.list.viewsize===this.statemachine.list.size){console.log("Complete list is through");this.statemachine.list.pagelen=0;this.statemachine.state="ready";this._hidespinner=!0}}ImageLoadError(){console.log("Image Load Error")}ImageSelected(){if("ready"===this._observerinit.imageselected){console.log("ImageSelected event"+this.selecteditem);if(null===this.selecteditem){console.log("Item NULL");this._selectiontimeout=setTimeout(function(){console.log("Timed Out Previous item");console.log(this._previousselection);this.setaction(this.statemachine.action.ITEM_SELECTED,this._previousselection)}.bind(this),50)}else{console.log("Item URL"+this.selecteditem.webp);clearTimeout(this._selectiontimeout);this._previousselection=JSON.parse(JSON.stringify(this.selecteditem));this.setaction(this.statemachine.action.ITEM_SELECTED,this.selecteditem)}}else this._observerinit.imageselected="ready"}databaseReady(){if(this.dbready)this.setaction(this.statemachine.action.FIREBASEINIT)}DatabaseSize(){if(0<this.listsize){console.log("List Size "+this.listsize);if("idle"===this.statemachine.state)this.setaction(this.statemachine.action.FIREASTOREINIT_SUCCESS,this.listsize);else this.setaction(this.statemachine.action.LIST_UPDATED,this.listsize)}}processData(){if("null"!=this.dataobject){console.log("Process the received data"+this.dataobject.get("sequence"));this.setaction(this.statemachine.action.HANDLE_DATA,this.dataobject)}}handleTrackEvent(evt){if("ready"===this.statemachine.state)this.setaction(this.statemachine.action.TRACK,evt)}displayToast(text,buttontext,time){this.$.papertoast.text=text;this.$.papertoast.duration=time;this.$.papertoastbutton.textContent=buttontext;this.$.papertoast.open()}displayToastClicked(){console.log("Display toast clicked");this.$.papertoast.close()}}window.customElements.define(MyView2.is,MyView2);</script></dom-module></body></html>