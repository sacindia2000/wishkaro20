<html><head><link rel="import" href="../../bower_components/polymer/polymer-element.html"><link rel="import" href="../../bower_components/iron-list/iron-list.html"><link rel="import" href="../../bower_components/iron-image/iron-image.html"><link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html"><link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html"><link rel="import" href="../../bower_components/paper-toast/paper-toast.html"><link rel="import" href="../../bower_components/paper-button/paper-button.html"><link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html"><link rel="import" href="../../bower_components/iron-icons/iron-icons.html"><link rel="import" href="../../bower_components/iron-icons/social-icons.html"><link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html"><link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html"><link rel="import" href="sharedstyles.html"><link rel="import" href="my-firestoreinit.html"><link rel="import" href="my-firestorequery.html"><link rel="import" href="my-overlay.html"></head><body><dom-module id="my-view1"><template><style include="sharedstyles">:host{top:92px;}</style><my-firestoreinit firestoreconfig="{{dbconfig}}" firestorelistsize="{{listsize}}" firestorecollectionhndl="{{dbhandle}}"></my-firestoreinit><my-firestorequery firestorereadconfig="{{dbreadconfig}}" firestorefetchdata="{{reqdata}}" firestoredataobject="{{dataobject}}"></my-firestorequery><my-overlay id="backdrop" with-backdrop="" style="width:auto; height:auto;  padding: 0px 0px 0px 0px;"><div class="lightboxcontainer"><div class="lightboxappheader"><paper-icon-button icon="arrow-back" style="color: white; left:16px; top:16px;" on-click="backkeyhandler"></paper-icon-button><paper-icon-button class="lightboxsocialpos" icon="social:share" style="color: white; top:16px;" on-click="sharekeyhandler"></paper-icon-button></div><iron-image style="position:fixed; top: 100px;margin-left:8px;  
  width:calc(100% - 16px); height:80%; z-index:110;" sizing="contain" src="{{selectedimageurl}}" error="{{imageloaderror}}"></iron-image></div></my-overlay><div class="container"><iron-list style="width:100%" items="[[imagearray]]" as="item" id="itemlist" scroll-target="document" selection-enabled="" selected-item="{{selecteditem}}" grid=""><template><div class="flexchild" style="width:calc(50% - .5px);"><iron-image class="imagecontainer" sizing="cover" style="width:calc(100% - 4px); height:180px; background-color: lightgray;" preload="" fade="" src="[[item.webp]]" error="{{imageloaderror}}"></iron-image></div></template></iron-list><template is="dom-if" if="{{!_hidespinner}}"><div class="spinnerpos"><paper-spinner active="" class="thick"></paper-spinner></div></template><paper-toast id="papertoast" class="fit-bottom" text="Hello world!"><paper-button id="papertoastbutton" style="left:16px;" on-click="displayToastClicked"></paper-button></paper-toast></div></template><script>const LIST_LIMIT=30,COLLECTION_NAME="popular",SEQUENCE_PARAMETER="sequence";class MyView1 extends Polymer.GestureEventListeners(Polymer.Element){static get is(){return"my-view1"}static get properties(){return{prop1:{type:String,value:"my-view1"},dbready:{type:Boolean,value:!1,observer:"databaseReady"},dbconfig:{type:Object,value:"null",notify:!0},dbreadconfig:{type:Object,value:"null",notify:!0},reqdata:{type:Boolean,value:!1,notify:!0},dataobject:{type:Object,value:"null",observer:"processData"},listsize:{type:Number,value:0,observer:"DatabaseSize"},dbhandle:{type:Object,value:"null"},imagearray:{type:Array},imageloaderror:{type:Boolean,value:!1,observer:"ImageLoadError"},selecteditem:{type:Object,observer:"ImageSelected"},_previousselection:{type:Object},_selectiontimeout:{type:Object},selectedimageurl:{type:String},_hidespinner:{type:Boolean,value:!1},statemachine:{type:Object},toaststate:{type:Object},androiduri:{type:String,valye:null}}}constructor(){super();this._observerinit={dbready:"none",dataobject:"none",listsize:"none",imageloaderror:"none",imageselected:"none"};this.imagearray=[];this.stateMachineConstructor();this.toaststate={NEW_CONTENT:"newcontent",MOVE_TAB:"movetab"}}ready(){super.ready();this.initializeStateMachine();Polymer.Gestures.addListener(this,"track",e=>this.handleTrackEvent(e));Polymer.Gestures.setTouchAction(this,"auto")}stateMachineConstructor(){this.statemachine={state:"idle",action:{FIREBASEINIT:"firebaseinit",FIREASTOREINIT_SUCCESS:"firestoreinitsuccess",TRACK:"trackevent",HANDLE_DATA:"handledata",LIST_UPDATED:"newdataind",ITEM_SELECTED:"urlSelected",SHARE_KEY:"shareClicked",BACK_KEY:"backClicked",TOAST_CLICKED:"toastClicked"},list:{size:0,newsize:0,viewsize:0,pagelen:0},transitions:{idle:{initialize:function(traget){this.target=traget},firebaseinit:function(){this.target.dbconfig={collection:COLLECTION_NAME,orderby:SEQUENCE_PARAMETER};console.log("Firebase Init complete")},firestoreinitsuccess:function(data){console.log("FirestoreInit success List size = "+data);this.target.statemachine.list.size=data;this.target.dbreadconfig={limit:LIST_LIMIT,index:0,orderby:SEQUENCE_PARAMETER};this.target.statemachine.state="processing";this.target.dbreadconfig.dbhandle=this.target.dbhandle;this.target.dbreadconfig.index=this.target.statemachine.list.size;this.target.reqdata=!this.target.reqdata},firestoreiniterror:function(){console.log("Firestore Init Error")},newdataind:function(data){console.log("New data is available");this.target.displayToast("New data idle","ok",2e3);this.target.statemachine.listsize=data}},ready:{initialize:function(traget){this.target=traget},newdataind:function(data){console.log("New data is available");this.target.displayToast("New data ready","ok",0);this.target.statemachine.list.newsize=data},trackevent:function(){console.log("Tracking started");if(0<this.target.statemachine.list.newsize){}if(this.target.$.itemlist.lastVisibleIndex>=this.target.imagearray.length-5&&this.target.statemachine.list.size>this.target.statemachine.list.viewsize){this.target.dbreadconfig.index=this.target.statemachine.list.size-this.target.statemachine.list.viewsize;this.target.statemachine.state="processing";this.target.reqdata=!this.target.reqdata}},urlSelected:function(url){console.log("Image item clciked READY");this.target.selectedimageurl=url.webp;this.target.statemachine.state="lightbox";this.target.openoverlay();var t0=performance.now(),request=new Request(url.jpg),Abort=new AbortController,Signal=Abort.signal;fetch(url.jpg).then(response=>{response.arrayBuffer().then(buffer=>{for(var byteArray=new Uint8Array(buffer),arr=new Uint8Array(byteArray.length),i=0;i<byteArray.length;i++){arr[i]=byteArray[i]}this.target.androiduri=window.Android.saveAsJPEG("test.jpg",arr);console.log("RETURN RESULT"+this.androiduri);var t1=performance.now();console.log("Call to doSomething took "+(t1-t0)+" milliseconds.")})})},toastClicked:function(){console.log("Toast clicked")}},processing:{initialize:function(traget){this.target=traget},error:function(){console.log("Error occured")},handledata:function(dataobj){console.log("Processing Data");var imageobject={};imageobject.webp=dataobj.get("webp");imageobject.jpg=dataobj.get("jpg");this.target.push("imagearray",imageobject);this.target.statemachine.list.viewsize++;this.target.statemachine.list.pagelen++;if(this.target.statemachine.list.pagelen===this.target.dbreadconfig.limit){console.log("Completed page read");this.target.statemachine.list.pagelen=0;this.target.statemachine.state="ready"}if(this.target.statemachine.list.viewsize===this.target.statemachine.list.size){console.log("Complete list is through");this.target.statemachine.list.pagelen=0;this.target.statemachine.state="ready";this.target._hidespinner=!0}},newdataind:function(data){console.log("New data is available");this.target.statemachine.newsize=data;this.target.displayToast("New data processing","ok",0)},toastClicked:function(){console.log("Toast Clicked")}},lightbox:{initialize:function(traget){this.target=traget},trackevent:function(){console.log("Ignore tracking events for now ")},shareClicked:function(){console.log("Share key pressd");window.Android.shareURI(this.target.androiduri)},backClicked:function(){console.log("Back key pressed");this.target.statemachine.state="ready";this.target.closeoverlay()},newdataind:function(data){console.log("New data is available");this.target.statemachine.newsize=data;this.target.displayToast("New data processing","ok",0)}}}}}initializeStateMachine(){this.statemachine.transitions.idle.initialize(this);this.statemachine.transitions.ready.initialize(this);this.statemachine.transitions.processing.initialize(this);this.statemachine.transitions.lightbox.initialize(this)}setaction(action,data){this.statemachine.transitions[this.statemachine.state][action](data)}ImageLoadError(){if("ready"===this._observerinit.imageloaderror){console.log("Image Loaded");this.imageload=!1}else this._observerinit.imageloaderror="ready"}ImageSelected(){if("ready"===this._observerinit.imageselected){console.log("ImageSelected event"+this.selecteditem);if(null===this.selecteditem){console.log("Item NULL");this._selectiontimeout=setTimeout(function(){console.log("Timed Out Previous item");console.log(this._previousselection);this.setaction(this.statemachine.action.ITEM_SELECTED,this._previousselection)}.bind(this),50)}else{console.log("Item URL"+this.selecteditem.webp);clearTimeout(this._selectiontimeout);this._previousselection=JSON.parse(JSON.stringify(this.selecteditem));this.setaction(this.statemachine.action.ITEM_SELECTED,this.selecteditem)}}else this._observerinit.imageselected="ready"}databaseReady(){if("ready"===this._observerinit.dbready){this.setaction(this.statemachine.action.FIREBASEINIT)}else this._observerinit.dbready="ready"}DatabaseSize(){if("ready"===this._observerinit.listsize){console.log("List Size "+this.listsize);if("idle"===this.statemachine.state)this.setaction(this.statemachine.action.FIREASTOREINIT_SUCCESS,this.listsize);else this.setaction(this.statemachine.action.LIST_UPDATED,this.listsize)}else this._observerinit.listsize="ready"}requestData(){this.reqdata=!this.reqdata}processData(){if("ready"===this._observerinit.dataobject){console.log("Process the received data"+this.dataobject.get("sequence"));this.setaction(this.statemachine.action.HANDLE_DATA,this.dataobject)}else this._observerinit.dataobject="ready"}handleTrackEvent(evt){if("ready"===this.statemachine.state)this.setaction(this.statemachine.action.TRACK,evt)}displayToast(text,buttontext,time){this.$.papertoast.text=text;this.$.papertoast.duration=time;this.$.papertoastbutton.textContent=buttontext;this.$.papertoast.open()}displayToastClicked(){console.log("Display toast clicked");this.$.papertoast.close();this.statemachine.list.size=this.statemachine.list.newsize;this.statemachine.list.viewsize=0;this.statemachine.list.newsize=0;this.imagearray.length=0;this.dbreadconfig.index=this.statemachine.list.size;this.statemachine.state="processing";this.reqdata=!this.reqdata}openoverlay(){this.$.backdrop.open();document.body.style.overflow="hidden"}closeoverlay(){this.$.backdrop.close();document.body.style.overflow=""}backkeyhandler(){this.setaction(this.statemachine.action.BACK_KEY)}sharekeyhandler(){this.setaction(this.statemachine.action.SHARE_KEY)}}window.customElements.define(MyView1.is,MyView1);</script></dom-module></body></html>