<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!-- Polymer Components -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<!-- App components -->
<link rel="import" href="sharedstyles.html">
<link rel="import" href="my-firestoreinit.html">
<link rel="import" href="my-firestorequery.html">


<dom-module id="my-view1">
  <template>
      <style include= "sharedstyles" >
         :host{
        top:92px;

      }
      [hidden] {
          display: none !important;
        }
      </style> 
    <my-firestoreinit firestoreconfig = "{{dbconfig}}" 
                      firestorelistsize = "{{listsize}}"
                      firestorecollectionhndl = "{{dbhandle}}"                              >
    </my-firestoreinit>
    <my-firestorequery firestorereadconfig = "{{dbreadconfig}}"
                       firestorefetchdata = "{{reqdata}}"
                       firestoredataobject = "{{dataobject}}"           
    ></my-firestorequery> 
    <div class = "container">
       <iron-list style = "width:100%"items="[[imagearray]]" as="item" id = "itemlist" scroll-target= "document"  
                  selection-enabled selected-item = "{{selectedItem}}" grid>
        <template>
            <div class = "flexchild"style="width:calc(50% - .5px);"> 
                <iron-image  class = "imagecontainer" sizing = "cover" style = "width:calc(100% - 4px); height:180px; background-color: lightgray;"
                preload fade src=[[item.webp]] error="{{imageloaderror}}"></iron-image>
         </div>
        </template>
      </iron-list>
      
      <template is="dom-if" if="{{!_hidespinner}}">
      <div class = "spinnerpos">
        <paper-spinner active> </paper-spinner>
      </div>
      </template>
      
      <paper-toast id = "papertoast" class="fit-bottom" text="Hello world!" >
      <paper-button id = "papertoastbutton" style= "left:16px;" onclick="displayToastClicked"  
                      >
      </paper-button>
      </paper-toast>
     </div> 
      
  </template>
  <script>
    /**
     * @customElement
     * @polymer
     */
    class MyView1 extends Polymer.GestureEventListeners (Polymer.Element) {
      static get is() { return 'my-view1'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'my-view1'
          },
          /** Check for DB to be ready before accessing **/ 
          dbready:
          {
            type:Boolean,
            value:false,
            observer:"databaseReady"
          },
        /** Set Data base configuration **/
          dbconfig:
          {
            type:Object,
            value:"null",
            notify:true
          },
          /** Set Data base configuration **/
          dbreadconfig:
          {
            type:Object,
            value:"null",
            notify:true
          },
          /** Request for data by toggling **/    
          reqdata:
          {
            type:Boolean,
            value:false,
            notify:true
          },
          /** Received data object **/
          dataobject:
          {
            type:Object,
            value:"null",
            observer:"processData"
          },
         
      /** Observer gets invoked each time list gets updated **/
          listsize:
          {
            type:Number,
            value:0,
            observer: "DatabaseSize"
          },
          /** handle to collection **/
          dbhandle:
          {
            type:Object,
            value: "null"
          },
          /** Object array storing the image objects **/
          imagearray: {
            type: Array
          },
          /** Observer to be called if image fails to load **/
          imageloaderror:{
          type : Boolean,
          value:false,
          observer: "ImageLoadError"
          },
         /** Hide the spinner at complete load etc **/ 
          _hidespinner:
          {
            type:Boolean,
            value:false
          } ,
         /** State machine to hold all status and events **/ 
          statemachine:
          {
            type:Object,
          
          } 
               }
      }
      
     /**
     * constructor
     * Polymer life cycle function  
     */

      constructor()
      {
        super();
        /** Polymer invokes observers once even before actual data is updated
            Add each observer here to make sure proper status is set 
        **/  
          this._observerinit = 
          {
            dbready: "none",
            dataobject : "none",
            listsize : "none",
            imageloaderror : "none"
          };
        this.imagearray = [];

        this.statemachine =
      {
           state: 'idle',
           action:
           {
             FIREBASEINIT:'firebaseinit',
             FIREASTOREINIT_SUCCESS:'firestoreinitsuccess',
             TRACK:'trackevent',
             HANDLE_DATA : 'handledata'
           },
           list:
           {
             size: 0,
             newsize: 0,
             viewsize:0,
             pagelen:0
           },
           transitions:
           {
                  idle:{
                          initialize : function (traget)
                          {
                             this.target = traget;
                            // this.target.state = 'ready';
                          },
                          firebaseinit: function (data)
                          {
                            /** Update Firestore Config to get size **/
                            this.target.dbconfig = 
                                        {
                                           collection: "popular",
                                           orderby:"sequence"
                                        };
                             console.log("Firebase Init complete");
                          } ,

                          firestoreinitsuccess : function (data,handle)
                          {
                             console.log("FirestoreInit success List size = " + data );
                             this.target.statemachine.list.size = data;
                             /** Total list size **/
                             this.target.dbreadconfig =
                                  {
                                      limit: 8,
                                      index: 0,
                                      orderby:"sequence"
                                  };
                             /** Change state **/
                             this.target.statemachine.state = 'processing';
                            /** Request for first set of data **/       
                            this.target.dbreadconfig.dbhandle = this.target.dbhandle;
                            /** Configure as per current count **/
                            this.target.dbreadconfig.index =  this.target.statemachine.list.size;
                            /** Toggele each time to get data **/
                            this.target.reqdata = !this.target.reqdata;
                            
                             
                          },
                          firestoreiniterror : function (data)
                          {
                             console.log("Firestore Init Error");
                          }

                       },
                   ready:
                      {
                        initialize : function (traget)
                          {
                             this.target = traget;
                            // this.target.state = 'ready';
                          }, 
                         newdataind : function (data)
                         {

                         },
                         trackevent : function ( evt)
                         {
                          console.log("Tracking started");
                          /** Check whether page need to be pre fetched **/
                          if(( this.target.$.itemlist.lastVisibleIndex >= (this.target.imagearray.length-5) )
                              && (this.target.statemachine.list.size > this.target.statemachine.list.viewsize) )
                             {
                                if(this.target.statemachine.list.size > this.target.statemachine.list.viewsize)
                                {
                                  this.target.dbreadconfig.index = this.target.statemachine.list.size - this.target.statemachine.list.viewsize;
                                  /** Change state **/
                                  this.target.statemachine.state = 'processing';
                                  /** Toggele each time to get data **/
                                  this.target.reqdata = !this.target.reqdata;
                                }
                             }
                            
                         },
                         itemclicked : function()
                         {
                           console.log("Image item clciked");
                         },
                         toastclicked : function()
                         {
                           console.log("Toast clicked");
                         }
                      },
                      processing:
                      {
                        initialize : function (traget)
                          {
                             this.target = traget;
                            // this.target.state = 'ready';
                          }, 
                         error : function()
                         {
                           console.log("Error occured");
                         },
                         handledata: function(dataobj)
                         {
                          console.log("Processing Data");
                          /** Push the object to view **/ 
                           var imageobject = new Object();
                           imageobject.webp = dataobj.get("webp");
                           imageobject.jpg = dataobj.get("jpg");
                           this.target.push('imagearray',imageobject);
                           /** Append count of objects within the view **/
                           this.target.statemachine.list.viewsize++;
                           this.target.statemachine.list.pagelen++;
                           /** Check for any state changes **/
                           if(this.target.statemachine.list.pagelen === this.target.dbreadconfig.limit)
                           {
                             console.log("Completed page read");
                             this.target.statemachine.list.pagelen = 0;
                              /** Change state **/
                              this.target.statemachine.state = 'ready';
                           }
                           if(this.target.statemachine.list.viewsize === this.target.statemachine.list.size)
                           {
                              console.log("Complete list is through");
                              this.target.statemachine.list.pagelen = 0;
                              /** Change state **/
                              this.target.statemachine.state = 'ready';
                              /** No need to fetch data so close spinner **/
                              this.target._hidespinner = true;

                           }
                           
                         }
                      }    
           }
      }        

      } /*8 End of constructor **/

      initializeStateMachine()
      {
        this.statemachine.transitions['idle']['initialize'](this);
        this.statemachine.transitions['ready']['initialize'](this);
        this.statemachine.transitions['processing']['initialize'](this);
      }

       setaction(action,data)
           {
              this.statemachine.transitions[this.statemachine.state][action](data);
            }



      ready()
      {
        super.ready();
        this.initializeStateMachine();
        Polymer.Gestures.addListener(this, 'track', e => this.handleTrackEvent(e));
        Polymer.Gestures.setTouchAction(this,"auto");
        console.log("My view 1 is ready");
      }

       ImageLoadError()
      {
        if(this._observerinit.imageloaderror === "ready")
        {
        console.log("Image Loaded");
        this.imageload = false;        
        }else
        this._observerinit.imageloaderror = "ready"
      }

      /**
     * @databaseReady
     * Observer invoked to inform completion of FireStore Init 
     */
      databaseReady()
      {
        if(this._observerinit.dbready === "ready")
        {
          this.setaction(this.statemachine.action.FIREBASEINIT);          
      }else
      this._observerinit.dbready = "ready";
      }



    DatabaseSize()
     {
      if(this._observerinit.listsize === "ready")
        {
           console.log("List Size " + this.listsize);
           this.setaction(this.statemachine.action.FIREASTOREINIT_SUCCESS,this.listsize);          
        }else
        this._observerinit.listsize = "ready";
    }

      requestData()
      {
        this.reqdata = !this.reqdata;
      }

    

      processData()
      {
        if(this._observerinit.dataobject === "ready")
        {
          console.log("Process the received data" + this.dataobject.get("sequence"));
          this.setaction(this.statemachine.action.HANDLE_DATA,this.dataobject);          
        }else
        this._observerinit.dataobject = "ready";
      }

          
     handleTrackEvent (evt)
      {
     
      if(this.statemachine.state === "ready")
      this.setaction(this.statemachine.action.TRACK,evt);          
      
      }

     /*** All interafces for view **/
     displayToast(text,buttontext,time)
     {
      this.$.papertoast.text = text;
      this.$.papertoast.duration = time;
      this.$.papertoastbutton.textContent = buttontext;  
      this.$.papertoast.open();
     }
     

     /*** All interafces for view **/

     /** Testing state machine **/
      
     
     
     /** Testing state machine **/

     }   /** End of Component **/
    
    

    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>
